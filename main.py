from fastapi import FastAPI, Request
from td_client import start_tdlib
import os
import openai

app = FastAPI()
openai.api_key = os.environ.get("OPENAI_API_KEY")

@app.get("/")
async def root():
    return {"message": "TDLib Telegram Audit API"}

@app.post("/analyze")
async def analyze(request: Request):
    data = await request.json()
    channel_url = data.get("channel_url")
    client = await start_tdlib()

    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ ‚Äî –∑–∞–º–µ–Ω–∏–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∂–µ
    title = "–ü—Ä–∏–º–µ—Ä –∫–∞–Ω–∞–ª–∞"
    description = "–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"
    pinned = "–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π –ø–æ—Å—Ç"
    posts = ["–ü–æ—Å—Ç 1", "–ü–æ—Å—Ç 2", "–ü–æ—Å—Ç 3"]

    prompt = f"""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Telegram-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π Telegram-–∫–∞–Ω–∞–ª –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.

üìå –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞:
–ù–∞–∑–≤–∞–Ω–∏–µ: {title}
–û–ø–∏—Å–∞–Ω–∏–µ: {description}
–ó–∞–∫—Ä–µ–ø: {pinned}
–ü–æ—Å—Ç—ã: {posts}

üîç –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞:

1. –ü–æ—Å—Ç-–∑–∞–∫—Ä–µ–ø: —ç—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞‚Äì–Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äú–ø—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞‚Äù –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –ø–æ—Å—Ç—ã. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø—Ä–æ —á—Ç–æ –∫–∞–Ω–∞–ª, –∫–æ–º—É –ø–æ–¥–æ–π–¥—ë—Ç (3 –±–æ–ª–∏), –∫—Ç–æ –∞–≤—Ç–æ—Ä (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–æ—Å—Ç "–æ–±–æ –º–Ω–µ"), —á—Ç–æ –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å, —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–ø-–ø–æ—Å—Ç—ã, –ø—Ä–∏–∑—ã–≤ —Å –∫–Ω–æ–ø–∫–æ–π –Ω–∞ —Ü–µ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ.
2. –ü–æ—Å—Ç ‚Äú–û–±–æ –º–Ω–µ‚Äù: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–µ–π—Å—ã, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –æ—Ñ—Ñ–µ—Ä –Ω–∞ –≤–æ—Ä–æ–Ω–∫—É.
3. –ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ—Å—Ç—ã: —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –±–æ–ª—å, —Ä–µ—à–µ–Ω–∏–µ, –ø–æ–ª—å–∑–∞, –ø—Ä–∏–∑—ã–≤ –∏–ª–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ.
4. –ü–æ—Å—Ç —Å –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–æ–º: –±–æ–ª—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∞—Ä–∫–∞, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å, –∫–Ω–æ–ø–∫–∞ —Å –±–æ—Ç–æ–º.
5. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞: –∏–º—è + –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–ø–æ–∏—Å–∫–æ–≤–æ–µ).
6. –û–ø–∏—Å–∞–Ω–∏–µ: —Ü–µ–ª—å –∫–∞–Ω–∞–ª–∞ + –∑–∞—á–µ–º –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è + –æ—Ç–∫—É–¥–∞ –Ω–∞—á–∞—Ç—å (—Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä–µ–ø).

üß† –ö–æ–Ω—Ç–µ–Ω—Ç-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è: 14-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –ø–æ —Ü–∏–∫–ª—É:

–î–µ–Ω—å 1 ‚Äî –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ/–±–æ–ª—å  
–î–µ–Ω—å 2 ‚Äî —Ç–≤–æ—è —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ—Å—Ç—å  
–î–µ–Ω—å 3 ‚Äî –æ—à–∏–±–∫–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É  
–î–µ–Ω—å 4 ‚Äî —Ä–µ—à–µ–Ω–∏–µ: –º–µ—Ç–æ–¥ –ø–æ —à–∞–≥–∞–º + –ø—Ä–∏–∑—ã–≤  
–î–µ–Ω—å 5 ‚Äî –∫–µ–π—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ + –ø—Ä–∏–∑—ã–≤  
–î–µ–Ω—å 6 ‚Äî –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π  
–î–µ–Ω—å 7 ‚Äî –ª–∞–π—Ñ/–∑–∞–∫—É–ª–∏—Å—å–µ  
–î–µ–Ω—å 8 ‚Äî –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ: –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ, –≤–æ–ø—Ä–æ—Å—ã  
–î–µ–Ω—å 9 ‚Äî –∞–Ω–æ–Ω—Å —ç—Ñ–∏—Ä–∞  
–î–µ–Ω—å 10 ‚Äî –ø–æ–¥–∞—Ä–∫–∏ + –≤—ã–≥–æ–¥—ã + –ø—Ä–∏–∑—ã–≤  
–î–µ–Ω—å 11 ‚Äî –¥–µ–Ω—å —ç—Ñ–∏—Ä–∞: 4 –ø–æ—Å—Ç–∞ (–Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞, –Ω–∞—á–∞–ª–æ, –ø—Ä–∏–∑—ã–≤)  
–î–µ–Ω—å 12 ‚Äî —ç–º–æ—Ü–∏–∏ –∏ –æ—Ç–∑—ã–≤—ã + –ø–æ–≤—Ç–æ—Ä –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è  
–î–µ–Ω—å 13 ‚Äî –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π + –¥–µ–¥–ª–∞–π–Ω  
–î–µ–Ω—å 14 ‚Äî –∫–µ–π—Å + –ø—Ä–∏–∑—ã–≤ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç

üîç –î–∞–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. –ß—Ç–æ —É–ª—É—á—à–∏—Ç—å –≤ —É–ø–∞–∫–æ–≤–∫–µ –∫–∞–Ω–∞–ª–∞?
2. –ù–∞—Å–∫–æ–ª—å–∫–æ –≤–æ–≤–ª–µ–∫–∞–µ—Ç –∑–∞–∫—Ä–µ–ø?
3. –û —á—ë–º –ø–æ–ª–µ–∑–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç ‚Äî –∏ —Ü–µ–ø–ª—è–µ—Ç –ª–∏?
4. –ï—Å—Ç—å –ª–∏ –º–æ–Ω–µ—Ç–∏–∑–∞—Ü–∏—è? –ß—Ç–æ –º–æ–∂–Ω–æ —É—Å–∏–ª–∏—Ç—å?
5. –ö–∞–∫–∏–µ 3 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —à–∞–≥–∞ —É–ª—É—á—à–∞—Ç –∫–∞–Ω–∞–ª?
"""

    response = openai.ChatCompletion.create(
        model="gpt-4",
        messages=[
            {"role": "user", "content": prompt}
        ]
    )

    gpt_reply = response.choices[0].message.content
    return {"analyze_result": gpt_reply}
