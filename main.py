from fastapi import FastAPI, Request
from td_client import start_tdlib
import os
import openai

app = FastAPI()
openai.api_key = os.environ.get("OPENAI_API_KEY")

@app.get("/")
async def root():
    return {"message": "TDLib Telegram Audit API"}

@app.post("/analyze")
async def analyze(request: Request):
    data = await request.json()
    channel_url = data.get("channel_url")
    client = await start_tdlib()

    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ ‚Äî –∑–∞–º–µ–Ω–∏–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∂–µ
    title = "–ü—Ä–∏–º–µ—Ä –∫–∞–Ω–∞–ª–∞"
    description = "–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"
    pinned = "–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π –ø–æ—Å—Ç"
    posts = ["–ü–æ—Å—Ç 1", "–ü–æ—Å—Ç 2", "–ü–æ—Å—Ç 3"]

    prompt = f"""
–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Telegram-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π Telegram-–∫–∞–Ω–∞–ª –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.

üìå –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞:
–ù–∞–∑–≤–∞–Ω–∏–µ: {title}
–û–ø–∏—Å–∞–Ω–∏–µ: {description}
–ó–∞–∫—Ä–µ–ø: {pinned}
–ü–æ—Å—Ç—ã: {posts}

üîç –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞:

1. –ü–æ—Å—Ç-–∑–∞–∫—Ä–µ–ø: —ç—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞-–Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äú–ø—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞‚Äù –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –ø–æ—Å—Ç—ã. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø—Ä–æ —á—Ç–æ –∫–∞–Ω–∞–ª, –∫–æ–º—É –ø–æ–¥–æ–π–¥—ë—Ç (3 –±–æ–ª–∏), –∫—Ç–æ –∞–≤—Ç–æ—Ä (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ‚Äú–æ–±–æ –º–Ω–µ‚Äù), —Ü–µ–Ω–Ω–æ—Å—Ç—å, —Å—Å—ã–ª–∫–∏ –Ω–∞ –ª—É—á—à–∏–µ –ø–æ—Å—Ç—ã, –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é —Å –∫–Ω–æ–ø–∫–æ–π.

2. –ü–æ—Å—Ç ‚Äú–û–±–æ –º–Ω–µ‚Äù: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–µ–π—Å—ã, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –æ—Ñ—Ñ–µ—Ä –Ω–∞ –≤–æ—Ä–æ–Ω–∫—É.

3. –ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ—Å—Ç—ã: —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –±–æ–ª—å, —Ä–µ—à–µ–Ω–∏–µ, –ø–æ–ª—å–∑–∞, –ø—Ä–∏–∑—ã–≤ –∏–ª–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ.

4. –ü–æ—Å—Ç —Å –ª–∏–¥-–º–∞–≥–Ω–∏—Ç–æ–º: –±–æ–ª—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∞—Ä–∫–∞, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å, –∫–Ω–æ–ø–∫–∞ —Å –±–æ—Ç–æ–º.

5. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞: –∏–º—è + –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–ø–æ–∏—Å–∫–æ–≤–æ–µ).

6. –û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞: –ø—Ä–æ —á—Ç–æ, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä–µ–ø.

7.–í–µ–¥–µ–Ω–∏–Ω–∏–µ –∫–∞–Ω–∞–ª–∞ –ø–æ 14-—Ç–∏ –¥–Ω–µ–≤–Ω–æ–º—É —Ü–∏–∫–ª—É –ø—Ä–æ–≥—Ä–µ–≤–∞: –î–µ–Ω—å 1: –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ –≤ —Ç–µ–º—É / –±–æ–ª—å

–û–ø—Ä–æ—Å, –ø—Ä–æ–≤–æ–∫–∞—Ü–∏—è –∏–ª–∏ –ª–∏—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è.
–¶–µ–ª—å: –∑–∞—Ü–µ–ø–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –∏ –∞–∫—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ–±–ª–µ–º—É.
–ü—Ä–∏–º–µ—Ä: ¬´–ß—Ç–æ –¥–ª—è –≤–∞—Å —Å–µ–π—á–∞—Å —Å–ª–æ–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏?¬ª –∏–ª–∏ ¬´–ö–æ–≥–¥–∞ —è –∑–∞–ø—É—Å–∫–∞–ª–∞ –ø–µ—Ä–≤—ã–π –∫—É—Ä—Å, —É –º–µ–Ω—è –Ω–µ –±—ã–ª–æ –Ω–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤, –Ω–∏ –ø–æ–Ω–∏–º–∞–Ω–∏—è, —Å —á–µ–≥–æ –Ω–∞—á–∞—Ç—å...¬ª
–î–µ–Ω—å 2: –ø–æ—á–µ–º—É –≤—ã –º–æ–∂–µ—Ç–µ –æ–± —ç—Ç–æ–º –≥–æ–≤–æ—Ä–∏—Ç—å

–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —Å–≤–æ—é —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é: —Ç–æ—á–∫–∞ –ê ‚Üí —Ç–æ—á–∫–∞ –ë.
–ü–æ–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø—Ä–æ—à–ª–∏.
–ü—Ä–∏–º–µ—Ä: ¬´–ö–æ–≥–¥–∞-—Ç–æ —è —Ç–æ–∂–µ –ø—Ä–æ–¥–∞–≤–∞–ª–∞ –Ω–∞ 0 —Ä—É–±–ª–µ–π, –∞ —Ç–µ–ø–µ—Ä—å –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç –º–∏–ª–ª–∏–æ–Ω—ã ‚Äî –∏ –≤–æ—Ç –∫–∞–∫ —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ...¬ª
–î–µ–Ω—å 3: —Ä–∞–∑–±–æ—Ä –æ—à–∏–±–æ–∫ –∞—É–¥–∏—Ç–æ—Ä–∏–∏

3‚Äì5 —Ç–∏–ø–∏—á–Ω—ã—Ö –æ—à–∏–±–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –º–µ—à–∞—é—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—É.
–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ: ¬´–ê –∫–∞–∫ –¥–µ–ª–∞—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ ‚Äî —Ä–∞—Å—Å–∫–∞–∂—É –∑–∞–≤—Ç—Ä–∞¬ª.
–î–µ–Ω—å 4: —Ä–µ—à–µ–Ω–∏–µ –∏ –º–µ—Ç–æ–¥

–†–∞—Å–∫—Ä—ã—Ç–∏–µ —Å—É—Ç–∏ –º–µ—Ç–æ–¥–∞: 3‚Äì5 —à–∞–≥–æ–≤, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã.
–î–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏-–∫–µ–π—Å –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
–í –∫–æ–Ω—Ü–µ ‚Äî –ø—Ä–∏–∑—ã–≤ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é / –ª–∏–¥-–º–∞–≥–Ω–∏—Ç / –ø—Ä–æ–¥—É–∫—Ç –¥–æ 3.000‚ÇΩ.
–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ: ¬´–¢–æ–ª—å–∫–æ –¥–æ –∫–æ–Ω—Ü–∞ –Ω–µ–¥–µ–ª–∏¬ª.
–î–µ–Ω—å 5: —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∏–µ–Ω—Ç–æ–≤

–°–∫—Ä–∏–Ω—à–æ—Ç—ã, –≤–∏–¥–µ–æ, —Ü–∏—Ç–∞—Ç—ã.
–ü—Ä–∏–º–µ—Ä: ¬´–í–æ—Ç, —á—Ç–æ –ø–æ–ª—É—á–∞—é—Ç –º–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã –ø–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –º–æ–µ–π —Å–∏—Å—Ç–µ–º—ã¬ª.
–î–µ–Ω—å 6: –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π

¬´–ú–Ω–µ –Ω–µ–∫–æ–≥–¥–∞¬ª, ¬´–Ø —É–∂–µ –ø—Ä–æ–±–æ–≤–∞–ª–∞¬ª, ¬´–≠—Ç–æ –¥–æ—Ä–æ–≥–æ¬ª.
–ü–æ–∫–∞–∂–∏—Ç–µ, –ø–æ—á–µ–º—É —ç—Ç–æ –Ω–µ —Ç–∞–∫ + –ø—Ä–∏–∑—ã–≤.
–î–µ–Ω—å 7: –ª–∞–π—Ñ / –ª–∏—á–Ω–æ–µ

–ñ–∏–≤–∞—è –∏—Å—Ç–æ—Ä–∏—è, —Ü–µ–Ω–Ω–æ—Å—Ç–∏, –±—É–¥–Ω–∏.
–ü—Ä–∏–º–µ—Ä: ¬´–ß–∞—Å—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç, –∫–∞–∫ —è –≤—Å—ë —É—Å–ø–µ–≤–∞—é —Å –¥–µ—Ç—å–º–∏ –∏ –±–∏–∑–Ω–µ—Å–æ–º...¬ª
–î–µ–Ω—å 8: –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ –≤ —ç—Ñ–∏—Ä

–ü–æ–¥–æ–≥—Ä–µ–≤: ¬´–•–æ—á—É —Å–¥–µ–ª–∞—Ç—å —ç—Ñ–∏—Ä, –≥–¥–µ —Ä–∞–∑–±–µ—Ä—É –≤—Å—ë –ø–æ —à–∞–≥–∞–º. –ö–æ–º—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ?¬ª
–î–µ–Ω—å 9: –∞–Ω–æ–Ω—Å —ç—Ñ–∏—Ä–∞

üìÜ –î–∞—Ç–∞ + üî• —Ç–µ–º–∞ + üéÅ –±–æ–Ω—É—Å—ã.
–¶–µ–ª—å: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —ç—Ñ–∏—Ä + –∞–∂–∏–æ—Ç–∞–∂.
–î–µ–Ω—å 10: –ø–æ–¥–∞—Ä–∫–∏ –∏ —á—Ç–æ –±—É–¥–µ—Ç –Ω–∞ —ç—Ñ–∏—Ä–µ

¬´–£—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—Ç: —á–µ–∫-–ª–∏—Å—Ç / –≥–∞–π–¥ / –±–æ–Ω—É—Å¬ª.
¬´–ß—Ç–æ –±—É–¥–µ—Ç –Ω–∞ —ç—Ñ–∏—Ä–µ: —à–∞–≥–∏, –æ—à–∏–±–∫–∏, –∫–µ–π—Å—ã¬ª.
–ü—Ä–∏–º–µ—Ä: ¬´–í —á–∞—Ç–µ —É–∂–µ 300+ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤. –•–æ—á–µ—à—å –∫ –Ω–∞–º?¬ª
–î–µ–Ω—å 11: –¥–µ–Ω—å —ç—Ñ–∏—Ä–∞

–ü–æ—Å—Ç 1 ‚Äî —É—Ç—Ä–µ–Ω–Ω–µ–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ.
–ü–æ—Å—Ç 2 ‚Äî ¬´–ì–æ—Ç–æ–≤–∏–º —ç—Ñ–∏—Ä!¬ª (—Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ).
–ü–æ—Å—Ç 3 ‚Äî ¬´–ú—ã –≤ —ç—Ñ–∏—Ä–µ! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è¬ª (—Å—Å—ã–ª–∫–∞).
–ü–æ—Å—Ç 4 ‚Äî –ø–æ—Å–ª–µ —ç—Ñ–∏—Ä–∞: ¬´–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–∏—Å—Ç–µ–º—É –ø–æ–¥ —Å–µ–±—è ‚Äî –ø—Ä–∏—Ö–æ–¥–∏ –Ω–∞ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é¬ª.
–î–µ–Ω—å 12: –æ—Ç–∑—ã–≤—ã –∏ —ç–º–æ—Ü–∏–∏

¬´–í–æ—Ç —á—Ç–æ –ø–∏—à—É—Ç —É—á–∞—Å—Ç–Ω–∏–∫–∏ —ç—Ñ–∏—Ä–∞¬ª.
–°–∫—Ä–∏–Ω—à–æ—Ç—ã + –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é.
–î–µ–Ω—å 13: –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π + –¥–µ–¥–ª–∞–π–Ω

¬´–ü–æ—Å–ª–µ–¥–Ω–∏–π —à–∞–Ω—Å ‚Äî –º–µ—Å—Ç–∞ –∑–∞–∫–∞–Ω—á–∏–≤–∞—é—Ç—Å—è / —Ü–µ–Ω–∞ —Ä–∞—Å—Ç—ë—Ç¬ª.
–î–æ–±–∞–≤—å —Ç–∞–π–º–µ—Ä –∏–ª–∏ –æ—Ç–º–µ—Ç–∫—É –æ –¥–µ–¥–ª–∞–π–Ω–µ.
–î–µ–Ω—å 14: –∫–µ–π—Å + –ø—Ä–∏–∑—ã–≤

–ü–æ–¥—Ä–æ–±–Ω—ã–π –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–µ–π—Å.
–ü–æ–∫–∞–∂–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–æ/–ø–æ—Å–ª–µ.
–í –∫–æ–Ω—Ü–µ: ¬´–•–æ—á–µ—à—å —Ç–∞–∫ –∂–µ? –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ—Å—Ç–≤–∏—é¬ª.

üì£ –ó–∞–≤–µ—Ä—à–∏ –∞–Ω–∞–ª–∏–∑ —Ñ—Ä–∞–∑–æ–π:
–•–æ—á–µ—à—å, —á—Ç–æ–±—ã –º—ã —Å–æ–±—Ä–∞–ª–∏ —Ç–∞–∫—É—é –≤–æ—Ä–æ–Ω–∫—É –ø–æ–¥ —Ç–≤–æ–π –∫–∞–Ω–∞–ª?
üëâ –ñ–º–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É - –•–û–ß–£ –ö–õ–ò–ï–ù–¢–û–í ‚Äî –∏ –ø—Ä–∏—Ö–æ–¥–∏ –Ω–∞ –±–µ—Å–ø–ª–∞—Ç–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é —Å –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥–æ–º –∞–≥–µ–Ω—Ç—Å—Ç–≤–∞  üåü
"""

    response = openai.ChatCompletion.create(
        model="gpt-3.5-turbo",
        messages=[{"role": "user", "content": prompt}],
        temperature=0.7
    )

    gpt_reply = response["choices"][0]["message"]["content"]
    return {"result": gpt_reply}

# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫
if __name__ == "__main__":
    import uvicorn
    uvicorn.run("main:app", host="0.0.0.0", port=int(os.environ.get("PORT", 8000)))
