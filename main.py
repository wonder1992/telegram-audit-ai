from fastapi import FastAPI, Request
import os
import openai

app = FastAPI()
openai.api_key = os.environ.get("OPENAI_API_KEY")

@app.get("/")
async def root():
    return {"message": "TDLib Telegram Audit API"}

@app.post("/analyze")
async def analyze(request: Request):
    data = await request.json()
    channel_url = data.get("channel_url")

    # –í—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–≥–ª—É—à–∫–∏ ‚Äî –∑–∞–º–µ–Ω–∏–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–∑–∂–µ
    title = "–ü—Ä–∏–º–µ—Ä –∫–∞–Ω–∞–ª–∞"
    description = "–û–ø–∏—Å–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞"
    pinned = "–ó–∞–∫—Ä–µ–ø–ª—ë–Ω–Ω—ã–π –ø–æ—Å—Ç"
    posts = ["–ü–æ—Å—Ç 1", "–ü–æ—Å—Ç 2", "–ü–æ—Å—Ç 3"]

    prompt = f"""
    –¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ Telegram-–º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π Telegram-–∫–∞–Ω–∞–ª –ø–æ —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–æ–¥–æ–ª–æ–≥–∏–∏.

    üìå –î–∞–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª–∞:
    –ù–∞–∑–≤–∞–Ω–∏–µ: {title}
    –û–ø–∏—Å–∞–Ω–∏–µ: {description}
    –ó–∞–∫—Ä–µ–ø: {pinned}
    –ü–æ—Å—Ç—ã: {posts}

    üîç –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è –∞–Ω–∞–ª–∏–∑–∞ –∫–∞–Ω–∞–ª–∞:
    
    1. –ü–æ—Å—Ç-–∑–∞–∫—Ä–µ–ø: —ç—Ç–æ –≤–æ—Ä–æ–Ω–∫–∞‚Äì–Ω–∞–≤–∏–≥–∞—Ü–∏—è ‚Äú–ø—É—Ç—å –∫–ª–∏–µ–Ω—Ç–∞‚Äù –≤–Ω—É—Ç—Ä–∏ –∫–∞–Ω–∞–ª–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ –Ω–∞ –¥—Ä—É–≥–∏–µ –≤–∞–∂–Ω—ã–µ –ø–æ—Å—Ç—ã. –°—Ç—Ä—É–∫—Ç—É—Ä–∞: –ø—Ä–æ —á—Ç–æ –∫–∞–Ω–∞–ª, –∫–æ–º—É –ø–æ–¥–æ–π–¥—ë—Ç (3 –±–æ–ª–∏), –∫—Ç–æ –∞–≤—Ç–æ—Ä (–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–æ—Å—Ç), —Ü–µ–Ω–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–∞, —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã–µ –ø–æ—Å—Ç—ã, —Ü–µ–ª–µ–≤–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (–∫–Ω–æ–ø–∫–∞).
    2. –ü–æ—Å—Ç ‚Äú–û–±–æ –º–Ω–µ‚Äù: –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, –∫–µ–π—Å—ã, –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã, –æ—Ñ—Ñ–µ—Ä –Ω–∞ –≤–æ—Ä–æ–Ω–∫—É.
    3. –ü–æ–ª–µ–∑–Ω—ã–µ –ø–æ—Å—Ç—ã: —Ç—Ä–∏–≥–≥–µ—Ä–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, –±–æ–ª—å, —Ä–µ—à–µ–Ω–∏–µ, –ø–æ–ª—å–∑–∞, –ø—Ä–∏–∑—ã–≤ –∏–ª–∏ –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ.
    4. –ü–æ—Å—Ç —Å –ª–∏–¥‚Äì–º–∞–≥–Ω–∏—Ç–æ–º: –±–æ–ª—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –ø–æ–¥–∞—Ä–∫–∞, –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –∫–∞–∫ –ø–æ–ª—É—á–∏—Ç—å, –∫–Ω–æ–ø–∫–∞ —Å –±–æ—Ç–æ–º.
    5. –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–Ω–∞–ª–∞: –∏–º—è + –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ (–ø–æ–∏—Å–∫–æ–≤–æ–µ).
    6. –û–ø–∏—Å–∞–Ω–∏–µ: –ø—Ä–æ —á—Ç–æ –∫–∞–Ω–∞–ª, –∑–∞—á–µ–º –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, —Å—Å—ã–ª–∫–∞ –Ω–∞ –∑–∞–∫—Ä–µ–ø.
    7. –ö–æ–Ω—Ç–µ–Ω—Ç‚Äì—Å—Ç—Ä–∞—Ç–µ–≥–∏—è: 14‚Äì–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥—Ä–µ–≤ –ø–æ —Ü–∏–∫–ª—É:
    –î–µ–Ω—å 1 ‚Äî –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ / –±–æ–ª—å
    –î–µ–Ω—å 2 ‚Äî –ø–æ—á–µ–º—É —Ç—ã —ç–∫—Å–ø–µ—Ä—Ç
    –î–µ–Ω—å 3 ‚Äî –æ—à–∏–±–∫–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥
    –î–µ–Ω—å 4 ‚Äî —Ä–µ—à–µ–Ω–∏–µ –∏ –º–µ—Ç–æ–¥
    –î–µ–Ω—å 5 ‚Äî –∫–µ–π—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤
    –î–µ–Ω—å 6 ‚Äî –∑–∞–∫—Ä—ã—Ç–∏–µ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π
    –î–µ–Ω—å 7 ‚Äî –ª–∞–π—Ñ / –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ
    –î–µ–Ω—å 8 ‚Äî –≤–æ–≤–ª–µ—á–µ–Ω–∏–µ ¬´—É—Å—Ç—Ä–æ—é —ç—Ñ–∏—Ä ‚Äî —Ö–æ—Ç–∏—Ç–µ?¬ª
    –î–µ–Ω—å 9 ‚Äî –∞–Ω–æ–Ω—Å —ç—Ñ–∏—Ä–∞ + —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
    –î–µ–Ω—å 10 ‚Äî –ø–æ–¥–∞—Ä–∫–∏ + –∑–∞—á–µ–º –ø—Ä–∏—Ö–æ–¥–∏—Ç—å
    –î–µ–Ω—å 11 ‚Äî –¥–µ–Ω—å —ç—Ñ–∏—Ä–∞ (4 –ø–æ—Å—Ç–∞: –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ, –∑–∞–∫—É–ª–∏—Å—å–µ, –Ω–∞—á–∞–ª–æ, –ø—Ä–∏–∑—ã–≤)
    –î–µ–Ω—å 12 ‚Äî —ç–º–æ—Ü–∏–∏ –∏ –æ—Ç–∑—ã–≤—ã –ø–æ—Å–ª–µ —ç—Ñ–∏—Ä–∞
    –î–µ–Ω—å 13 ‚Äî –æ—Ç—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑—Ä–∞–∂–µ–Ω–∏–π + –ø—Ä–∏–∑—ã–≤ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç
    –î–µ–Ω—å 14 ‚Äî –∫–µ–π—Å + –ø—Ä–∏–∑—ã–≤ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç

    –°—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–∞–Ω–∞–ª–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –∏–∑ –ø—É–Ω–∫—Ç–æ–≤.
    """

    response = await openai.ChatCompletion.acreate(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "–¢—ã ‚Äî Telegram-–º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—à—å –∫–∞–Ω–∞–ª—ã –ø–æ —É–ø–∞–∫–æ–≤–∫–µ, –∑–∞–∫—Ä–µ–ø—É, –∫–æ–Ω—Ç–µ–Ω—Ç—É –∏ –≤–æ—Ä–æ–Ω–∫–µ."},
            {"role": "user", "content": prompt}
        ]
    )
    result = response.choices[0].message.content

    return {"result": result, "channel_url": channel_url}
